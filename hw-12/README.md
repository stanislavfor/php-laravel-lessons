# Продвинутое программирование на PHP — Laravel
## Урок 12. Интеграция с внешними сервисами
### Домашнее задание
<br><br>
Цели практической работы:<br>

Научиться:<br>

— интегрировать отправку писем через почтовый клиент;<br>
— настраивать отправку сообщений в мессенджер.<br>

Что нужно сделать:<br>

В этой практической работе вы реализуете уведомления через внешние сервисы.<br>

1. Создайте новый проект Laravel или откройте уже существующий.

2. Создайте новую ветку вашего репозитория от корневой (main или master).

3. Настройте регистрацию и аутентификацию пользователей.

4. Настройте почтовый клиент любого сервиса.

5. Впишите в файл .env нужные значения для почтового сервиса.

6. Создайте письмо Welcome.php командой php artisan make:mail Welcome.

7. В конструкторе класса присвойте свойству класса $user параметр конструктора класса.

```
public User $user;
public function __construct(User $user)
{
$this->user = $user;
}
```

8. Создайте шаблон мейлинга welcome.blade.php в директории resources/views/emails с кодом внутри

```
Добрый день,
{
{ $user -> name }
},
спасибо за регистрацию.

```

9. Добавьте код отправки вашего письма в функцию store класса RegisteredUserController.

10. Подключите клиент мессенджера Telegram командой composer require irazasyed/telegram-bot-sdk

11. Создайте бота и канал, добавьте бота в телеграм-канал.

12. Укажите в файле .env значения, необходимые для работы бота.

13. Проверьте работу бота с помощью тестового маршрута.

```
Route::get('test-telegram', function () {
Telegram::sendMessage([
'chat_id' => env('TELEGRAM_CHANNEL_ID', ''),
'parse_mode' => 'html',
'text' => 'Произошло тестовое событие'
]);
return response()->json([
'status' => 'success'
]);
});
```

14. Добавьте код уведомления в мессенджер о новом пользователе вашей системы в функцию store класса RegisteredUserController.

15. Зарегистрируйтесь на сайте.

16. Проверьте, что сообщение отправлено на электронную почту (рекомендуется использовать для регистрации тот почтовый ящик, с которого отправляется сообщение, чтобы избежать блокировки адреса за спам).

17. Проверьте, что в Telegram пришло уведомление о регистрации нового пользователя.



##
## Домашнее задание
Открыть терминал и перейти в папку с уроком:
```
cd hw-12
```
## Инструкция
### 1. Создать новый проект Laravel

- Открыть терминал и выполнить команду:
```
laravel new twelfth-laravel-app
```

- Перейти в директорию проекта:
```
cd twelfth-laravel-app
```

### 2. Создать новую ветку репозитория

- Инициализировать git:
```
git init
```
- Создать и переключиться на новую ветку:
```
git checkout -b feature/notifications
```

### 3. Настроить регистрацию и аутентификацию

- Установить `библиотеку Breeze`:
```
composer require laravel/breeze
```

- Установить компоненты Breeze:
```
php artisan breeze:install
```

- Установить зависимости и собрать проект:
```
npm install
npm run dev
```

- Выполнить миграции:
```
php artisan migrate
```

- Запустить сервер и проверить, что регистрация работает:
```
php artisan serve
```

### 4. Настроить почтовый клиент

- Выбрать почтовый сервис, например, Mail, Mailtrap, Gmail, SMTP
- Получить данные для настройки почтового подключения

### 5. Указать значения в файле окружения

- Открыть файл `.env` и вписать параметры почтового сервера, например:

```
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=ваш_логин
MAIL_PASSWORD=ваш_пароль
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS=example@example.com
MAIL_FROM_NAME="Laravel App"
```
- Сохранить файл.

### 6. Создать письмо Welcome

Выполнить команду:
```
php artisan make:mail Welcome
```

### 7. Добавить свойство и конструктор в класс письма

Открыть файл `app/Mail/Welcome.php` и добавить функцию:

```php
use App\Models\User;

public User $user;

public function __construct(User $user)
{
    $this->user = $user;
}
```

### 8. Создать шаблон письма

Создать файл `welcome.blade.php` в директории `resources/views/emails` и добавить код:

```
Добрый день,  
{{ $user->name }},  
спасибо за регистрацию.
```

### 9. Добавить отправку письма в контроллер регистрации

Открыть файл `app/Http/Controllers/Auth/RegisteredUserController.php`, в метод store добавить строку после создания пользователя:

```
use App\Mail\Welcome;
use Illuminate\Support\Facades\Mail;

Mail::to($user->email)->send(new Welcome($user));
```

### 10. Установить клиент Telegram

Выполнить команду:
```
composer require irazasyed/telegram-bot-sdk
```

### 11. Создать Telegram-бота и канал

1. Перейти в Telegram
2. Открыть BotFather
3. Создать нового бота и получить токен
4. Создать канал
5. Добавить бота в канал и назначить его администратором

### 12. Указать данные в файле .env

Добавить параметры:

```
TELEGRAM_BOT_TOKEN=токен_бота
TELEGRAM_CHANNEL_ID=@имя_канала
```

### 13. Проверить работу Telegram-бота

- Открыть `routes/web.php` и добавить маршрут:
```
use Telegram\Bot\Laravel\Facades\Telegram;

Route::get('test-telegram', function () {
    Telegram::sendMessage([
        'chat_id' => env('TELEGRAM_CHANNEL_ID', ''),
        'parse_mode' => 'html',
        'text' => 'Произошло тестовое событие'
    ]);
    return response()->json([
        'status' => 'success'
    ]);
});
```

- Перейти в браузере по адресу [http://localhost:8000/test-telegram](http://localhost:8000/test-telegram)
- Проверить, что сообщение появилось в Telegram-канале

### 14. Добавить отправку Telegram-сообщения при регистрации

В файле `RegisteredUserController.php`, в метод `store` после строки с отправкой письма добавить:

```
Telegram::sendMessage([
    'chat_id' => env('TELEGRAM_CHANNEL_ID', ''),
    'parse_mode' => 'html',
    'text' => 'Новый пользователь зарегистрирован: ' . $user->name
]);
```

### 15. Зарегистрироваться на сайте

- Открыть терминал в корне проекта и запустить встроенный сервер Laravel, если ещё не запущен. 
  По умолчанию приложение будет доступно по адресу [http://localhost:8000](http://localhost:8000):
```
php artisan serve
```
- Перейти на сайт. На главной странице должна быть доступна ссылка или кнопка `Register` (Регистрация).
- Зарегистрировать нового пользователя:
  - Нажать на ссылку Register.
  - В открывшейся форме заполнить поля:

     - Name** - ввести имя пользователя
     - Email - ввести действующий адрес электронной почты, на который будет отправлено письмо
     - Password - ввести надёжный пароль
     - Confirm Password - повторно ввести тот же пароль для подтверждения
  - Нажать кнопку `Register` для отправки формы. После успешной регистрации должно произойти перенаправление на главную страницу сайта или в личный кабинет. В этот момент будет выполнено следующее:

     - Пользователь будет автоматически аутентифицирован
     - На указанный адрес электронной почты будет отправлено приветственное письмо (если правильно настроен почтовый клиент)
     - В Telegram-канал будет отправлено уведомление о новом пользователе<br><br>

- Если регистрация прошла успешно, но почта или Telegram не сработали, необходимо вернуться к шагам 4–14 и проверить настройки сервиса отправки писем и параметров Telegram-бота.
- Если при регистрации возникла ошибка, открыть консоль браузера (F12 → вкладка Console) и лог Laravel в файле `storage/logs/laravel.log`, чтобы найти описание ошибки. Также убедиться, что все миграции выполнены, зависимости установлены, а почтовая и Telegram-конфигурации корректны.

### 16. Проверить получение письма

- Проверить, что на указанный адрес пришло письмо
- Использовать адрес почтового ящика, совпадающий с адресом отправителя

### 17. Проверить сообщение в Telegram

Проверить, что в канал отправлено уведомление о регистрации пользователя

### 18. Создать коммит

При необходимости по окончанию работы, оформить финальный коммит и отправить изменения в удалённый репозиторий.





<br><br><hr>
**В качестве решения приложить:** <br>
➔ ссылку на репозиторий с домашним заданием <br>
⚹ записать необходимые пояснения к выполненному заданию<br>
<hr>

**Критерии оценки работы:** <br>

**Принято:** <br>

— выполнены все пункты работы; <br>
— в работе используются указанные инструменты, соблюдены условия; <br>
— код корректно отформатирован по стандартам программирования на PHP; <br>
— код запускается, выводит данные на экран, не вызывает ошибок. <br>

**На доработку:** <br>
— выполнены не все пункты работы; <br>
— работа выполнена с ошибками. <br>

**Как отправить работу на проверку:** <br>

Отправьте коммит, содержащий код задания, на ветку master в вашем репозитории и пришлите его URL (URL Merge Request’а) через форму. Репозиторий должен быть public.


![PHP Laravel Framework](../archives/i-min.jpg)