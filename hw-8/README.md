# Продвинутое программирование на PHP — Laravel
## Урок 8. Сервисы: создание и использование
### Домашнее задание
<br><br>
Цели практической работы:<br>

Научиться:<br>

— создавать свои сервисы на Laravel;<br>
— работать с логами Laravel и их обработкой.<br>

Что нужно сделать:<br>

В этой практической работе вы разработаете сервис логирования, который:<br>
— фиксирует обращения к сайту;<br>
— собирает их в базе данных с возможностью отключения системы логирования;<br>
— отражает в реальном времени HTTP-запросы к приложению.<br>

Создадим новый проект:<br>

composer create-project laravel/laravel log-service

1. Для начала создадим модель логов. Для создания модели необходимо использовать artisan с параметром make:model.<br>
   В итоге наша команда будет выглядеть так:<br>

php artisan make:model Log

По умолчанию модель создаётся в ./app/Models/Log.php.<br>
Модель создана, для избежания ошибок запросов SQL необходимо отключить автоматические метки времени.<br>
![](../archives/pic-8-1.jpg)<br>
2. Теперь опишем миграцию для создания нашей таблицы логов:<br>

php artisan make:migration create_logs_table

Напомним, что таблицы миграции создаются по умолчанию в /database/migration/current_date_time_create_logs_table.php.<br>

По умолчанию создаётся файл, содержимое которого выглядит так:<br>
![](../archives/pic-8-2.jpg)<br>
В этом файле нам нужно определить поля, которые будет собирать наш сервис логирования:<br>
— time — время события;<br>
— duration — длительность;<br>
— IP — IP-адрес зашедшего пользователя;<br>
— url — адрес, который запросил пользователь;<br>
— method — HTTP-метод (GET, POST);<br>
— input — передаваемые параметры.<br>

В итоге файл должен приобрести такой вид:<br>
![](../archives/pic-8-3.jpg)<br>

3. Миграция создана, параметры описаны. Теперь создадим таблицу.<br>

Напоминаем, что таблица создаётся также через artisan c параметром migrate php artisan migrate.

4. База данных подготовлена, теперь нужно создать звено (middleware) для обработки HTTP-запросов. Напоминаем, что звенья создаются при помощи команды php artisan make:middleware название модели.

В нашем случае нам нужна команда:<br>
php artisan make:middleware DataLogger

По умолчанию звено (посредник) создастся по пути ./app/Http/Middleware/DataLogger.php.<br>
Теперь необходимо настроить middleware. Открываем Datalogger.php. Добавим использование созданной модели.<br>
![](../archives/pic-8-4.jpg)<br>
Также нужно завершить создание middleware DataLogger, зарегистрировать его в ./app/Http/Kernel.php.<br>
![](../archives/pic-8-5.jpg)<br>
5. Модель создана, посредник HTTP-запросов настроен и зарегистрирован как класс в Kernel.php. Если сейчас запустить Laravel командой php artisan serv, всё будет работать. Логи будут записываться в базу данных.
   Но увидеть это можно только в самой базе SQL. Для получения более наглядных результатов необходимо создать в web.php эндпоинт.
   ![](../archives/pic-8-6.jpg)<br>
   Также для этого эндпоинта необходимо создать blade-шаблон: ./resource/view/logs.blade.php

В нём создать запрос к базе SQL и вывод логов в таблицу.<br>
![](../archives/pic-8-7.jpg)<br>
Запускаем приложение, при открытии вашего приложения http://localhost:8000/logs должна открываться таблица с логами обращения к сайту.


<br><br><hr>
**В качестве решения приложить:** <br>
➔ ссылку на репозиторий с домашним заданием <br>
⚹ записать необходимые пояснения к выполненному заданию<br>
<hr>

**Критерии оценки работы:** <br>

**Принято:** <br>

— выполнены все пункты работы; <br>
— Сервис запускается без ошибок. <br>
— Логи HTTP-запросов фиксируются в БД. <br>
— Логи отображаются в веб-интерфейсе в реальном времени. <br>

**На доработку:** <br>
— выполнены не все пункты работы; <br>
— работа выполнена с ошибками. <br>

**Как отправить работу на проверку:** <br>

Отправьте коммит, содержащий код задания, на ветку master в вашем репозитории и пришлите его URL (URL Merge Request’а) через форму. Репозиторий должен быть public.


![PHP Laravel Framework](../archives/i-min.jpg)

<br><br><br>